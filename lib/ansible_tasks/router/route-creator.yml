---
- hosts: "{{ HOST }}"
  remote_user: "{{ USER }}"
  port: "{{ PORT }}"
  gather_facts: no

  vars_files:
    - "{{ CONTAINER_VARS }}"

  vars:

    NGINX_SITES_DIR:    '/etc/nginx/sites-enabled'
    NGINX_SOURCE_FILE:  'nginx.tmpl'

    SITE_DIR:            "{{ NGINX_SITES_DIR }}/{{ APPLICATION_NAME }}"
    SSL_DIR:             "{{ SITE_DIR }}/ssl"
    NGINX_TARGET_FILE:   "{{ SITE_DIR }}/nginx.conf"
    NGINX_PASSWORD_FILE: "{{ SITE_DIR }}/htpassword"

  tasks:

    - name: "Create htpasswords dir"
      file: path={{ item }} owner=root group=root state=directory
      with_items:
      - "{{ SITE_DIR }}"
      - "{{ SSL_DIR }}"

    - name: "Install Nginx config file : {{ NGINX_TARGET_FILE }}"
      template: src={{ NGINX_SOURCE_FILE }} dest={{ NGINX_TARGET_FILE }}
      notify:
        - reload nginx

    - name: "Delete htpassword file"
      file: path={{ NGINX_PASSWORD_FILE }} state=absent
      tags:
        - install_apache

    - name: "Populate htpassword file"
      htpasswd: path={{ NGINX_PASSWORD_FILE }} name={{ item['login'] }} password={{ item['password'] }} owner=root group=www-data mode=0640
      when: HTPASSWORD is defined and HTPASSWORD|length != 0
      with_items: HTPASSWORD

  handlers:

    - name: reload nginx
      command: /etc/init.d/nginx reload
