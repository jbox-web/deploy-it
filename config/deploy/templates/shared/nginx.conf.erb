upstream <%= fetch(:application) %>-puma {
  server unix:<%= remote_path_for(shared_path) %>/tmp/sockets/puma.sock fail_timeout=0;
}

upstream <%= fetch(:application) %>-faye {
  server unix:<%= remote_path_for(shared_path) %>/tmp/sockets/faye.sock fail_timeout=0;
}

<%- config = fetch(:nginx_vhost, {}) -%>
<%- domain = config[:domain] -%>

server {
  server_name   <%= domain %>;
  listen        4443 ssl http2;
  listen        127.0.0.1:5000;
  root          <%= remote_path_for(deploy_to) %>/current/public;

  access_log    <%= remote_path_for(shared_path) %>/log/nginx.access.log;
  error_log     <%= remote_path_for(shared_path) %>/log/nginx.error.log;

  ssl on;
  ssl_certificate       /etc/nginx/sites-admin/ssl-certificates/server.crt;
  ssl_certificate_key   /etc/nginx/sites-admin/ssl-certificates/server.key;

  location / {
    try_files $uri @deploy_it;
  }

  location @deploy_it {
    # Headers
    include /etc/nginx/proxy_params;

    # Options
    proxy_redirect     off;
    proxy_read_timeout 300;

    # Pass to Rails
    proxy_pass http://<%= fetch(:application) %>-puma;
  }

  location /faye {
    # Headers
    include /etc/nginx/proxy_params;

    proxy_http_version 1.1;

    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    gzip off;
    expires off;

    chunked_transfer_encoding off;
    proxy_buffering           off;
    proxy_cache               off;
    proxy_redirect            off;
    proxy_send_timeout        850000;
    proxy_read_timeout        850000;
    proxy_connect_timeout     850000;

    # Pass to Faye
    proxy_pass http://<%= fetch(:application) %>-faye;
  }
}
